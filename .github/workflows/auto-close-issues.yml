name: Auto-Close Issues

on:
  push:
    branches:
      - main
    paths:
      - 'development/logs/XVADUR_LOG.md'

jobs:
  close-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update && sudo apt-get install -y jq
          else
            echo "jq already installed"
          fi
      
      - name: Parse log for completed quests
        id: parse-log
        run: |
          # Parsuj XVADUR_LOG.md a n√°jdi dokonƒçen√© √∫lohy
          # Form√°t: [HH:MM] ‚úÖ Dokonƒçen√° √∫loha #123: [Popis]
          COMPLETED_ISSUES=$(grep -oP '‚úÖ Dokonƒçen√° √∫loha #\K[0-9]+' development/logs/XVADUR_LOG.md || echo "")
          
          if [ -z "$COMPLETED_ISSUES" ]; then
            echo "completed_issues=" >> $GITHUB_OUTPUT
            echo "No completed issues found"
          else
            echo "completed_issues=$COMPLETED_ISSUES" >> $GITHUB_OUTPUT
            echo "Found completed issues: $COMPLETED_ISSUES"
          fi
      
      - name: Close completed issues
        if: steps.parse-log.outputs.completed_issues != ''
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Zatvor ka≈æd√© dokonƒçen√© Issue
          COMPLETED_ISSUES="${{ steps.parse-log.outputs.completed_issues }}"
          CLOSED_COUNT=0
          FAILED_COUNT=0
          
          for issue_num in $COMPLETED_ISSUES; do
            echo "Processing issue #$issue_num"
            
            # Skontroluj, ƒçi Issue existuje a ak√Ω m√° stav
            STATE_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$issue_num")
            
            HTTP_CODE=$(echo "$STATE_RESPONSE" | tail -n1)
            STATE_BODY=$(echo "$STATE_RESPONSE" | head -n-1)
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "‚ö†Ô∏è  Issue #$issue_num: HTTP $HTTP_CODE (mo≈æno neexistuje alebo nem√°me pr√≠stup)"
              FAILED_COUNT=$((FAILED_COUNT + 1))
              continue
            fi
            
            STATE=$(echo "$STATE_BODY" | jq -r '.state // "unknown"')
            
            if [ "$STATE" = "open" ]; then
              # Zatvor Issue
              CLOSE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$issue_num" \
                -d '{"state":"closed"}')
              
              CLOSE_HTTP_CODE=$(echo "$CLOSE_RESPONSE" | tail -n1)
              
              if [ "$CLOSE_HTTP_CODE" = "200" ]; then
                echo "‚úÖ Closed issue #$issue_num"
                CLOSED_COUNT=$((CLOSED_COUNT + 1))
              else
                echo "‚ùå Failed to close issue #$issue_num (HTTP $CLOSE_HTTP_CODE)"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            else
              echo "‚ÑπÔ∏è  Issue #$issue_num is already $STATE (skipping)"
            fi
          done
          
          echo ""
          echo "üìä Summary:"
          echo "  ‚úÖ Closed: $CLOSED_COUNT"
          echo "  ‚ùå Failed: $FAILED_COUNT"
      
      - name: Summary
        if: always()
        run: |
          if [ -z "${{ steps.parse-log.outputs.completed_issues }}" ]; then
            echo "No completed issues found in log"
          else
            echo "Processed completed issues: ${{ steps.parse-log.outputs.completed_issues }}"
          fi

