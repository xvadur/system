# XVADUR Daily Metrics Workflow
# Automatický výpočet XP a aktualizácia metrík každý deň

name: Daily Metrics

on:
  schedule:
    # Každý deň o 23:59 (UTC) = 00:59 CET
    - cron: '59 22 * * *'
  workflow_dispatch:  # Manuálne spustenie

permissions:
  contents: write

jobs:
  calculate-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Debug - Workflow start and file check
        run: |
          echo "DEBUG: Daily metrics workflow started at $(date)"
          echo "DEBUG: Checking input files:"
          ls -la development/data/prompts_log.jsonl 2>/dev/null || echo "WARNING: prompts_log.jsonl missing"
          ls -la development/logs/XVADUR_LOG.md 2>/dev/null || echo "WARNING: XVADUR_LOG.md missing"
          echo "DEBUG: prompts_log size: $(wc -l < development/data/prompts_log.jsonl 2>/dev/null || echo 'unknown')"
          echo "DEBUG: log size: $(wc -l < development/logs/XVADUR_LOG.md 2>/dev/null || echo 'unknown')"

      - name: Calculate XP
        continue-on-error: true
        run: |
          python -c "
          import sys
          import os
          from pathlib import Path
          
          sys.path.insert(0, '.')
          
          prompts_log = Path('development/data/prompts_log.jsonl')
          xvadur_log = Path('development/logs/XVADUR_LOG.md')
          
          # Skontroluj existenciu súborov
          if not prompts_log.exists():
              print('⚠️  prompts_log.jsonl neexistuje, vytváram prázdny súbor')
              prompts_log.parent.mkdir(parents=True, exist_ok=True)
              prompts_log.touch()
          
          if not xvadur_log.exists():
              print('⚠️  XVADUR_LOG.md neexistuje, vytváram základný súbor')
              xvadur_log.parent.mkdir(parents=True, exist_ok=True)
              xvadur_log.write_text('# XVADUR Log\n\n', encoding='utf-8')
          
          try:
              from scripts.calculate_xp import calculate_xp, update_xp_file
              
              print('DEBUG: Starting XP calculation...')
              xp_data = calculate_xp(str(prompts_log), str(xvadur_log))
              print(f'DEBUG: Calculated XP data: {xp_data}')
              update_xp_file('development/logs/XVADUR_XP.md', xp_data)
              print(f'✅ XP: {xp_data[\"total_xp\"]} (Level {xp_data[\"current_level\"]})')
          except Exception as e:
              print(f'❌ Chyba pri výpočte XP: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "

      - name: Debug - Post-calculation check
        run: |
          echo "DEBUG: After XP calculation:"
          if [ -f "development/logs/XVADUR_XP.md" ]; then
            echo "DEBUG: XVADUR_XP.md updated, last lines:"
            tail -5 development/logs/XVADUR_XP.md
          else
            echo "ERROR: XVADUR_XP.md was not created/updated!"
          fi
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          
          echo "DEBUG: Git status before commit:"
          git status
          echo "DEBUG: Git diff summary:"
          git diff --stat
          
          if git diff --staged --quiet; then
            echo "ℹ️  No changes to commit"
          else
            git commit -m "chore(metrics): daily XP update [skip ci]"
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push origin "$CURRENT_BRANCH" || echo "⚠️  Push failed"
          fi

